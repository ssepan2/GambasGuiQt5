' Gambas class file

Class Anchor Inherits DockAnchorBase
'Constants
'

'Enums
'

'Fields
'

'ctor()
'
'Public Sub _new(controlParam As Control, formParam As Form, usingMenubarParam As Boolean, iAnchorMaskParam As Integer)
Public Sub _new(iAnchorMaskParam As Integer)
    'Note: not doing this ByRef, but pointers seem to be working to change passed controls.

    'only used to validate options
    'Dim aiAnchorEnums As New Integer[]

    ' Super.$ctlControl = controlParam
    ' Super.$frmForm = formParam
    ' Super.$bUsingMenubar = usingMenubarParam
    '
    ' 'Note; must call New before form resizes in order to capture initial design
    ' Super.$iControlDesignerX = Super.$ctlControl.X
    ' Super.$iControlDesignerY = Super.$ctlControl.Y
    ' Super.$iControlDesignerWidth = Super.$ctlControl.Width
    ' Super.$iControlDesignerHeight = Super.$ctlControl.Height
    '
    ' ' Super.$iFormDesignerX = Super.$frmForm.X
    ' ' Super.$iFormDesignerY = Super.$frmForm.Y 'Don't care about these 1st two
    ' Super.$iFormDesignerWidth = formParam.Width 'Need these last two
    ' Super.$iFormDesignerHeight = Super.$frmForm.Height

    Super.$iAnchor = iAnchorMaskParam

    'validate combinations
    If (Super.$iAnchor > (Me.AnchorTop + Me.AnchorRight + Me.AnchorBottom + Me.AnchorLeft)) Or (Super.$iAnchor < 0) Then
        Error.Raise(Subst("invalid Anchor mask: &1", Super.$iAnchor))
    Endif
    ' aiAnchorEnums = [AnchorNone, AnchorTop, AnchorRight, AnchorBottom, AnchorLeft]
    ' If (Not aiAnchorEnums.Exist(Super.$iAnchor)) Then
    '     Error.Raise(Subst("invalid Anchor enum: &1", Super.$iAnchor))
    ' Endif

    ' Debug Subst("c:&1,x:&2,y:&3,W:&4,h:&5,a:&6", Super.$ctlControl.Name, Super.$iControlDesignerX, Super.$iControlDesignerY, Super.$iControlDesignerWidth, Super.$iControlDesignerHeight, Super.$iAnchor)
Catch
    Debug Log.FormatError
    Debug Error.Text

End

Public Sub Apply()
    'TODO:allow a 2nd control param to indicate current control is going to dock next to it; 2nd will have to be called after 1st and should be passed reference to first
    ' Note:must call in form resize, after any changes to form size
    ' Note:each anchor and dock is unaware of other, so ones sharing the same corner may overlap

    Dim iWorkingClientWidth As Integer = 0
    Dim iWorkingClientHeight As Integer = 0
    Dim iFormNetChangeWidth As Integer = 0
    Dim iFormNetChangeHeight As Integer = 0

    Super.$iControlNewX = Super.$iControlDesignerX
    Super.$iControlNewY = Super.$iControlDesignerY
    Super.$iControlNewWidth = Super.$iControlDesignerWidth
    Super.$iControlNewHeight = Super.$iControlDesignerHeight

    'Try to use passed form reference
    ' $iFormNewX = $frmForm.X
    ' $iFormNewY = $frmForm.Y 'Don't care about these 1st two
    ' $iFormNewWidth = $frmForm.Width 'Need these last two
    ' $iFormNewHeight = $frmForm.Height
    'Debug Subst("f:w=&1,h=&2", $iFormNewWidth, $iFormNewHeight)

    'Note:use Max() when subtracting anything applied directly to a property
    iWorkingClientWidth = Max(Super.$frmForm.Width - (2 * Super.$frmForm.Padding), 0)
    iWorkingClientHeight = Max(Super.$frmForm.Height - IIf(Super.$bUsingMenubar, Me.MENUBAR_HEIGHT, 0) - (2 * Super.$frmForm.Padding), 0)

    iFormNetChangeWidth = Super.$frmForm.Width - Super.$iFormDesignerWidth
    iFormNetChangeHeight = Super.$frmForm.Height - Super.$iFormDesignerHeight
    ' Debug Subst("f:dW=&1,dH=&2", iFormNetChangeWidth, iFormNetChangeHeight)

    'anchor
    If Super.$iAnchor <> Me.AnchorNone Then
        'FIRST need to work out each side INDIVIDUALLY (or with OPPOSITE), and THEN perform move
        If ((Super.$iAnchor And Me.AnchorTop) > 0) And ((Super.$iAnchor And Me.AnchorBottom) > 0) Then
            'Top and Bottom
            Super.$iControlNewY = Super.$iControlDesignerY
            Super.$iControlNewHeight = Max(Super.$iControlDesignerHeight + iFormNetChangeHeight, Super.$iControlDesignerHeight) 'design height will be treated as a minumum
        Else
            If (Super.$iAnchor And Me.AnchorTop) > 0 Then
                'Top, not Bottom
                Super.$iControlNewY = Super.$iControlDesignerY 'Note: This will have no visible effect
            Endif
            If (Super.$iAnchor And Me.AnchorBottom) > 0 Then
                'Bottom, not Top
                Super.$iControlNewY = Max(Super.$iControlDesignerY + iFormNetChangeHeight, Super.$frmForm.Padding)
            Endif
        Endif
        If ((Super.$iAnchor And Me.AnchorLeft) > 0) And ((Super.$iAnchor And Me.AnchorRight) > 0) Then
            'Left and Right
            Super.$iControlNewX = Super.$iControlDesignerX
            Super.$iControlNewWidth = Max(Super.$iControlDesignerWidth + iFormNetChangeWidth, Super.$iControlDesignerWidth) 'design width will be treated as a minumum
        Else
            If (Super.$iAnchor And Me.AnchorLeft) > 0 Then
                'Left, not Right
                Super.$iControlNewX = Super.$iControlDesignerX 'Note: This will have no visible effect
            Endif
            If (Super.$iAnchor And Me.AnchorRight) > 0 Then
                'Right, not Left
                Super.$iControlNewX = Max(Super.$iControlDesignerX + iFormNetChangeWidth, Super.$frmForm.Padding)
            Endif
        Endif
        Super.$ctlControl.Move(Super.$iControlNewX, Super.$iControlNewY, Super.$iControlNewWidth, Super.$iControlNewHeight)
    Endif

Catch
    Debug Log.FormatError
    Debug Error.Text

End
